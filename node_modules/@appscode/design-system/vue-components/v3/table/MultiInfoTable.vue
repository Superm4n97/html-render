<script setup lang="ts">
import type { AcTableCol } from "../../types/table";
import { defineAsyncComponent, ref, computed, watch } from "vue";

interface Props {
  isLoaderActive?: boolean;
  isTableEmpty?: boolean;
  tableHeaders?: Array<AcTableCol>;
  removeContentPadding?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  isLoaderActive: false,
  isTableEmpty: false,
  tableHeaders: () => [],
  removeContentPadding: false,
});

const TableContainer = defineAsyncComponent(() => import("../table/TableContainer.vue"));
const EmptyTableInfo = defineAsyncComponent(() => import("../table/EmptyTableInfo.vue"));
const TableRow = defineAsyncComponent(() => import("../table/TableRow.vue"));
const TableCell = defineAsyncComponent(() => import("../table/TableCell.vue"));
const CellValue = defineAsyncComponent(() => import("../table/table-cell/CellValue.vue"));

const loaderCols = ref(5);
const headerSortables = ref<Array<{ enabled: boolean; mode: string }>>([]);

const isFullTableLoaderActive = computed(() => {
  return !props.tableHeaders.length;
});

const headerLabels = computed(() => {
  return props.tableHeaders.map((th) => (typeof th === "string" ? th : th?.name || "Label"));
});

watch(
  () => props.tableHeaders,
  (n) => {
    if (headerSortables.value.length === n.length) {
      n.forEach((th, idx) => {
        if (headerSortables.value[idx].enabled !== !!th?.sort?.enable) {
          headerSortables.value[idx].enabled = !!th?.sort?.enable;
          headerSortables.value[idx].mode = "";
        }
      });
    } else {
      headerSortables.value = n.map((th) => {
        if (typeof th === "string") {
          return {
            enabled: false,
            mode: "",
          };
        } else {
          return {
            enabled: !!th?.sort?.enable,
            mode: "",
          };
        }
      });
    }
  }
);
</script>

<template>
  <table-container>
    <table class="table ac-info-table is-fullwidth" :class="{ 'pl-0 pr-0': removeContentPadding }">
      <tbody v-if="isFullTableLoaderActive">
        <table-row v-for="i in loaderCols" :key="i">
          <table-cell>
            <cell-value :is-loader-active="true" />
          </table-cell>
          <table-cell>
            <cell-value :is-loader-active="true" />
          </table-cell>
        </table-row>
      </tbody>
      <tbody
        v-else
        :class="{
          'no-data-available has-text-centered p-10': isTableEmpty,
          'pl-0 pr-0': removeContentPadding,
        }"
      >
        <template v-if="!isTableEmpty">
          <table-row v-for="(tableHeader, idx) in tableHeaders" :key="headerLabels[idx]">
            <table-cell>
              <slot :name="`table-cell-icon-${idx}`" />
              {{ headerLabels[idx] }}
            </table-cell>
            <table-cell v-if="isLoaderActive">
              <cell-value :is-loader-active="true" />
            </table-cell>
            <slot v-else :name="`slot-${idx}`" />
          </table-row>
        </template>

        <empty-table-info v-else />
      </tbody>
    </table>

    <!-- pagination start -->
    <slot name="table-pagination" />
    <!-- pagination end -->
  </table-container>
</template>
