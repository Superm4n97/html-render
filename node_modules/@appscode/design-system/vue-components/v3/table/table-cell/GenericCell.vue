<script setup lang="ts">
import type { AcTableCell, AcTableCol } from "../../../types/table";
import { defineAsyncComponent } from "vue";
import { useRoute } from "vue-router";

interface Props {
  cellDescriptor?: AcTableCol;
  cellValue?: AcTableCell;
}

const props = withDefaults(defineProps<Props>(), {
  cellValue: () => ({ data: "-" }),
  cellDescriptor: () => ({
    name: "-",
    type: "string",
    priority: 3,
    pathTemplate: "-",
  }),
});

const Tag = defineAsyncComponent(() => import("../../tag/Tag.vue"));
const CellValue = defineAsyncComponent(() => import("../../table/table-cell/CellValue.vue"));

const route = useRoute();
function getCellLink(cell: AcTableCell) {
  const inject = (str: string, obj: Record<string, string>) => str.replace(/\${(.*?)}/g, (x, g) => obj[g]);
  const { user, cluster } = route.params;
  const link = inject(cell.link || "", {
    username: user as string,
    clustername: cluster as string,
  });
  return link;
}
function redirectTo() {
  const link = getCellLink(props.cellValue);
  window.open(link, "_blank");
}
</script>

<template>
  <span
    :class="{
      'is-flex': cellDescriptor.type !== 'object',
      'is-align-items-center': cellValue.icon,
      'is-justify-content-center': cellDescriptor.textAlign === 'center',
      'is-justify-content-left': cellDescriptor.textAlign === 'left',
      'is-justify-content-right': cellDescriptor.textAlign === 'right',
    }"
  >
    <span v-if="cellValue.icon" class="icon p-0 mr-10">
      <img width="15" :src="cellValue.icon" />
    </span>
    <a
      v-if="cellValue.link && cellValue.link.startsWith('http')"
      :href="getCellLink(cellValue)"
      @click.prevent="redirectTo"
    >
      {{ cellValue.data }}
    </a>
    <router-link v-else-if="cellValue.link" :to="getCellLink(cellValue)">
      {{ cellValue.data }}
    </router-link>
    <tag v-else-if="cellValue.color" :class="`is-${cellValue.color}`">
      {{ cellValue.data }}
    </tag>
    <cell-value
      v-else
      :cell-title="cellDescriptor.name"
      :value="cellValue.data as {} || '-'"
      :tooltip="cellValue.tooltip || JSON.stringify(cellValue.data)"
    />
  </span>
</template>
