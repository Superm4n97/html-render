<script setup lang="ts">
import { defineAsyncComponent, ref, computed } from "vue";

interface Props {
  cellTitle?: string;
  items?: Array<any>;
  maxCharacterLength?: number;
}

const props = withDefaults(defineProps<Props>(), {
  cellTitle: "cell-title",
  maxCharacterLength: 50,
  items: () => [],
});

const Tags = defineAsyncComponent(() => import("../../tag/Tags.vue"));
const Tag = defineAsyncComponent(() => import("../../tag/Tag.vue"));
const EllipsisIcon = defineAsyncComponent(() => import("../../icons/Ellipsis.vue"));
const JsonShowModal = defineAsyncComponent(() => import("../../modals/JsonShowModal.vue"));
const ValueWithModal = defineAsyncComponent(() => import("../../table/table-cell/ValueWithModal.vue"));

const showFullData = ref(false);

const printableStringObjs = computed(() => {
  return props.items.map((item) => {
    const value = item as Record<string, unknown>;
    let exceededLength = false;
    let print: string | Record<string, unknown> = item;
    if (typeof item === "object") {
      exceededLength = true;
      print = (item["Name"] as string) || (item["name"] as string) || (item[Object.keys(item)[0]] as string);
    } else {
      const stringifiedValue = JSON.stringify(item);
      exceededLength = stringifiedValue.length > 27;
      print = exceededLength ? `${stringifiedValue.slice(0, 27)}...` : stringifiedValue;
    }
    return { value, exceededLength, print };
  });
});

const indexOfCharacterLengthExceed = computed(() => {
  let idx = -1;
  let cumulativeLen = 2;
  for (const [index, po] of printableStringObjs.value.entries()) {
    const newLen = cumulativeLen + po.print.length + 2;
    if (newLen + 4 > props.maxCharacterLength) {
      idx = index;
      break;
    }
    cumulativeLen = newLen;
  }

  return idx === -1 ? printableStringObjs.value.length : idx;
});
</script>

<template>
  <span>
    <tags v-if="printableStringObjs.length">
      <tag
        v-for="(printableStringOb, idx) in printableStringObjs.slice(0, indexOfCharacterLengthExceed)"
        :key="`${printableStringOb.print}-${idx}`"
        modifierClasses="is-primary is-light"
      >
        <value-with-modal
          v-if="printableStringOb.exceededLength"
          :title="`${cellTitle}: ${idx}`"
          :value="printableStringOb.value"
          :print="printableStringOb.print"
        />
        <template v-else> {{ printableStringOb.print }} </template>
      </tag>

      <tag v-if="indexOfCharacterLengthExceed !== printableStringObjs.length">
        <a @click.prevent.stop="showFullData = true">
          <ellipsis-icon />
          <json-show-modal
            :open="showFullData"
            @closemodal="showFullData = false"
            :editor-title="cellTitle"
            :editor-content="items"
          />
        </a>
      </tag>
    </tags>
    <p v-else>{{ printableStringObjs }}</p>
  </span>
</template>
