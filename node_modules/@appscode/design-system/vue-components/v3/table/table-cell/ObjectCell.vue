<script setup lang="ts">
import { defineAsyncComponent, ref, computed } from "vue";

interface Props {
  cellTitle?: string;
  obj?: Record<string, unknown>;
  maxCharacterLength?: number;
}

const props = withDefaults(defineProps<Props>(), {
  cellTitle: "cell title",
  maxCharacterLength: 64,
  obj: () => ({}),
});

const Tags = defineAsyncComponent(() => import("../../tag/Tags.vue"));
const Tag = defineAsyncComponent(() => import("../../tag/Tag.vue"));
const EllipsisIcon = defineAsyncComponent(() => import("../../icons/Ellipsis.vue"));
const JsonShowModal = defineAsyncComponent(() => import("../../modals/JsonShowModal.vue"));
const ValueWithModal = defineAsyncComponent(() => import("../../table/table-cell/ValueWithModal.vue"));

const showFullData = ref(false);

const objKeys = computed(() => {
  return Object.keys(props.obj) || [];
});

const printableStringObjs = computed(() => {
  return objKeys.value.map((key) => {
    let value: string = props.obj[key] as string;
    if (typeof value === "object" && value !== null) {
      value = JSON.stringify(value);
    }
    const keyValue = `${key}: ${value}`;
    const exceededLength = keyValue.length > 30;
    const print = exceededLength ? key : keyValue;
    return { key, value, keyValue, exceededLength, print };
  });
});

const indexOfCharacterLengthExceed = computed(() => {
  let idx = -1;
  let cumulativeLen = 2;
  for (const [index, po] of printableStringObjs.value.entries()) {
    const newLen = cumulativeLen + po.print.length + 2;
    if (newLen + 4 > props.maxCharacterLength) {
      idx = index;
      break;
    }
    cumulativeLen = newLen;
  }

  return idx === -1 ? printableStringObjs.value.length : idx;
});
</script>

<template>
  <span>
    <tags v-if="printableStringObjs.length">
      <tag
        v-for="printableStringOb in printableStringObjs.slice(0, indexOfCharacterLengthExceed)"
        :key="printableStringOb.key"
        modifierClasses="is-secondary is-light"
      >
        <value-with-modal
          v-if="printableStringOb.exceededLength"
          :title="printableStringOb.key"
          :value="printableStringOb.value"
          :print="printableStringOb.print"
        />
        <template v-else> {{ printableStringOb.print }} </template>
      </tag>

      <tag modifierClasses="is-secondary is-light" v-if="indexOfCharacterLengthExceed !== printableStringObjs.length">
        <a @click.prevent.stop="showFullData = true">
          <ellipsis-icon />
          <json-show-modal
            :open="showFullData"
            @closemodal="showFullData = false"
            :editor-title="cellTitle"
            :editor-content="obj"
          />
        </a>
      </tag>
    </tags>
    <p v-else>-</p>
  </span>
</template>
