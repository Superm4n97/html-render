<script setup lang="ts">
import { computed, defineAsyncComponent, ref } from "vue";
import { useElementSize } from "@vueuse/core";

interface Props {
  isLoaderActive?: boolean;
  cellTitle?: string;
  value?: unknown;
  tooltip?: string;
}

const props = withDefaults(defineProps<Props>(), {
  isLoaderActive: false,
  cellTitle: "cell title",
  tooltip: "",
  value: () => ({}),
});

const ContentLoader = defineAsyncComponent(() =>
  import("vue-content-loader").then(({ ContentLoader }) => ContentLoader)
);
const ObjectCell = defineAsyncComponent(() => import("../../table/table-cell/ObjectCell.vue"));
const ArrayCell = defineAsyncComponent(() => import("../../table/table-cell/ArrayCell.vue"));

const loaderLightThemePrimaryColor = "#f5f7f9";
const loaderDarkThemePrimaryColor = "#2e323c";
const loaderLightThemeSecondaryColor = "#ecebeb";
const loaderDarkThemeSecondaryColor = "#21272e";

const cellLoaderDiv = ref<HTMLElement | null>(null);
const cellDiv = ref<HTMLElement | null>(null);

const valueType = computed(() => {
  if (typeof props.value === "object") {
    if (props.value === null) return "null";
    else if (Array.isArray(props.value)) return "array";
    else return "object";
  } else return typeof props.value;
});

const { width: cellLoaderDivWidth } = useElementSize(cellLoaderDiv, {
  width: 150,
  height: 30,
});
const { width: cellDivWidth } = useElementSize(cellDiv, {
  width: 150,
  height: 30,
});
const maxCharacterLength = computed(() => {
  return Math.ceil(cellDivWidth.value / 6);
});

const primaryColor = computed(() => {
  return document.documentElement.classList.contains("is-dark-theme")
    ? loaderDarkThemePrimaryColor
    : loaderLightThemePrimaryColor;
});

const secondaryColor = computed(() => {
  return document.documentElement.classList.contains("is-dark-theme")
    ? loaderDarkThemeSecondaryColor
    : loaderLightThemeSecondaryColor;
});
</script>

<template>
  <div v-if="isLoaderActive" ref="cellLoaderDiv" :style="{ maxWidth: '300px' }">
    <content-loader
      :view-box="`0 0 ${cellLoaderDivWidth || 300} 10`"
      :speed="2"
      :key="cellLoaderDivWidth"
      :primaryColor="primaryColor"
      :secondaryColor="secondaryColor"
    />
  </div>
  <div v-else ref="cellDiv">
    <object-cell
      v-if="valueType === 'object'"
      :obj="value as Record<string, unknown>"
      :cell-title="cellTitle"
      :max-character-length="maxCharacterLength"
      data-testid="object-cell-value"
    />
    <array-cell
      v-else-if="valueType === 'array'"
      :items="value as Array<unknown>"
      :cell-title="cellTitle"
      :max-character-length="maxCharacterLength"
      data-testid="array-cell-value"
    />
    <template v-else>
      <span :title="tooltip" data-testid="cell-value">{{ value || (value === 0 ? 0 : "-") }}</span>
    </template>
  </div>
</template>
