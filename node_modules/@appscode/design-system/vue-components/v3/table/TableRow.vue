<script setup lang="ts">
import { defineAsyncComponent, nextTick, ref } from "vue";

type OverflowType =
  | "auto"
  | "clip"
  | "hidden"
  | "scroll"
  | "visible"
  | "inherit"
  | "initial"
  | "revert"
  | "revert-layer"
  | "unset";

interface Props {
  link?: string;
  isSelected?: boolean;
  isDisabled?: boolean;
  fakeCellWidth?: number;
  collapsible?: boolean;
  collapsibleContentMaxHeight?: string;
  collapsibleOverflowX?: OverflowType;
}

const prop = withDefaults(defineProps<Props>(), {
  link: "",
  isSelected: false,
  isDisabled: false,
  fakeCellWidth: 0,
  collapsible: false,
  collapsibleContentMaxHeight: "60vh",
  overflowX: "unset",
});

const emit = defineEmits(["rowselect", "rowexpand", "rowcollapse"]);

const collapsibleRow = ref(null as HTMLElement | null);

const TableCell = defineAsyncComponent(() => import("./TableCell.vue"));
const FakeTableCell = defineAsyncComponent(() => import("./FakeTableCell.vue"));
const CollapsibleButton = defineAsyncComponent(() => import("../button/Button.vue"));

const isCollapsed = ref(true);
const collapsibleRowMaxHeight = ref("0vh");

const collapseRow = () => {
  isCollapsed.value = true;
};

const toggleCollapse = () => {
  const newVal = !isCollapsed.value;
  if (!newVal) {
    isCollapsed.value = newVal;
    // show expand animation
    nextTick(() => {
      setTimeout(() => {
        if (collapsibleRow.value) {
          collapsibleRow.value.classList.remove("is-closed");
          collapsibleRow.value.classList.add("is-active");
          collapsibleRowMaxHeight.value = prop.collapsibleContentMaxHeight;
        }
        emit("rowexpand", collapseRow);
      }, 0);
    });
  } else {
    if (collapsibleRow.value) {
      collapsibleRow.value.classList.remove("is-active");
      collapsibleRow.value.classList.add("is-closed");
      collapsibleRowMaxHeight.value = "0vh";
    }
    setTimeout(() => {
      // remove row after animation finish
      isCollapsed.value = newVal;
      emit("rowcollapse");
    }, 100);
  }
};
</script>

<template>
  <router-link v-if="link" v-slot="{ navigate }" event="click" :to="link" custom>
    <tr class="is-link" v-bind="$attrs" data-testid="ac-table-row" @click="navigate">
      <table-cell v-if="collapsible">
        <collapsible-button
          modifier-classes="is-square is-light height-20 width-20 is-rounded is-size-7 p-0"
          :icon-class="isCollapsed ? 'chevron-right' : 'chevron-down'"
          @click.stop="toggleCollapse"
        />
      </table-cell>
      <slot />
      <fake-table-cell v-if="fakeCellWidth > 0" :fake-cell-width="fakeCellWidth" />
    </tr>
  </router-link>
  <tr
    v-else
    v-bind="$attrs"
    :class="{
      'is-selected': isSelected,
      'is-hoverless': !isSelected,
      'is-disabled': isDisabled,
    }"
    data-testid="ac-table-row"
    @click.prevent="$emit('rowselect', true)"
  >
    <table-cell v-if="collapsible">
      <collapsible-button
        modifier-classes="is-square is-light height-20 width-20 is-rounded is-size-7 p-0"
        :icon-class="isCollapsed ? 'chevron-right' : 'chevron-down'"
        @click.stop="toggleCollapse"
      />
    </table-cell>
    <slot />
    <fake-table-cell v-if="fakeCellWidth > 0" :fake-cell-width="fakeCellWidth" />
  </tr>
  <transition name="slide-down" mode="out-in" appear>
    <tr v-if="collapsible && !isCollapsed" v-bind="$attrs">
      <table-cell colspan="1000" class="table-inner-shadow">
        <div
          ref="collapsibleRow"
          class="collapsible-row"
          :style="{
            maxHeight: collapsibleRowMaxHeight,
            overflowX: collapsibleOverflowX,
          }"
        >
          <slot name="collapsible-content" />
        </div>
      </table-cell>
    </tr>
  </transition>
</template>
