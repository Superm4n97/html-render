<script setup lang="ts">
import { computed, defineAsyncComponent, nextTick, onUpdated, ref, watch } from "vue";
import type { AcTableCol } from "../../types/table";

interface Props {
  isLoaderActive?: boolean;
  isTableEmpty?: boolean;
  tableHeaders?: Array<AcTableCol>;
  collapsible?: boolean;
  actionable?: boolean;
  actionableHeader?: string;
  isDynamicWidthTable?: boolean;
  fullWidth?: number;
  columnStriped?: boolean;
  modifierClass?: string;
  isCustom?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  isLoaderActive: false,
  isTableEmpty: true,
  tableHeaders: () => [],
  collapsible: false,
  actionable: false,
  actionableHeader: "",
  isDynamicWidthTable: false,
  fullWidth: 1920,
  columnStriped: false,
  modifierClass: "",
  isCustom: false,
});

const emit = defineEmits(["sort", "scroller"]);

const TableContainer = defineAsyncComponent(() => import("../table/TableContainer.vue"));
const TableRow = defineAsyncComponent(() => import("../table/TableRow.vue"));
const TableCell = defineAsyncComponent(() => import("../table/TableCell.vue"));
const CellValue = defineAsyncComponent(() => import("../table/table-cell/CellValue.vue"));
const EmptyTableInfo = defineAsyncComponent(() => import("../table/EmptyTableInfo.vue"));
const FakeTableCell = defineAsyncComponent(() => import("../table/FakeTableCell.vue"));

const fakeCellWidth = ref(0);
const headerSortables = ref<Array<{ enabled: boolean; mode: string }>>([]);
const ac_table = ref(null as HTMLElement | null);
const ac_table_container = ref(null as HTMLElement | null);
const headerLabels = computed(() => {
  return props.tableHeaders.map((th) => (typeof th === "string" ? th : th?.name || "Label"));
});

const isFullTableLoaderActive = computed(() => {
  return !props.tableHeaders.length;
});

const loaderCols = computed(() => {
  if (isFullTableLoaderActive.value) {
    return 5;
  } else if (props.isLoaderActive) {
    return Math.max(props.tableHeaders.length + 1, 5);
  } else {
    return props.tableHeaders.length || 5;
  }
});

const handleScroller = (value: number) => {
  emit("scroller", value);
};

const onWindowResize = () => {
  if (ac_table.value && props.isDynamicWidthTable) {
    const tableWidth = ac_table.value.clientWidth;
    const d = props.fullWidth - tableWidth;
    fakeCellWidth.value = d;
  }
};

const emitSortEvent = (index: number) => {
  const emitValue = {
    index,
    label: props.tableHeaders[index].name,
    mode: "",
  };

  headerSortables.value.forEach((hs, idx) => {
    if (idx !== index) hs.mode = "";
    else {
      if (hs.mode === "asc") hs.mode = "desc";
      else hs.mode = "asc";

      emitValue.mode = hs.mode;
    }
  });

  emit("sort", emitValue);
};

watch(
  () => props.tableHeaders,
  (n) => {
    if (headerSortables.value.length === n.length) {
      n.forEach((th, idx) => {
        if (headerSortables.value[idx].enabled !== !!th?.sort?.enable) {
          headerSortables.value[idx].enabled = !!th?.sort?.enable;
          headerSortables.value[idx].mode = "";
        }
      });
    } else {
      headerSortables.value = n.map((th) => {
        if (typeof th === "string") {
          return {
            enabled: false,
            mode: "",
          };
        } else {
          return {
            enabled: !!th?.sort?.enable,
            mode: "",
          };
        }
      });
    }
  },
  { immediate: true }
);

onUpdated(() => {
  nextTick(() => {
    onWindowResize();
  });
});
</script>

<template>
  <div class="table-wrapper" :class="modifierClass">
    <table-container ref="ac_table_container" @scroller="handleScroller">
      <table
        ref="ac_table"
        class="table ac-table is-bordered"
        :class="{
          'is-fullwidth': !isDynamicWidthTable || isFullTableLoaderActive || isTableEmpty || isLoaderActive,
          // 'ac-striped': !columnStriped,
          // 'is-bordered': columnStriped,
        }"
      >
        <thead>
          <table-row v-if="isFullTableLoaderActive">
            <th v-for="i in loaderCols" :key="i">
              <cell-value :is-loader-active="true" />
            </th>
          </table-row>
          <table-row v-else>
            <th v-if="collapsible" style="width: 20px" />
            <th
              v-for="(tableHeader, idx) in tableHeaders"
              :key="idx"
              :class="{
                sorting: headerSortables[idx].enabled,
                'sorting-desc': headerSortables[idx].mode === 'desc',
                'sorting-asc': headerSortables[idx].mode === 'asc',
                'has-text-centered': typeof tableHeader === 'string' ? false : tableHeader.textAlign === 'center',
                'has-text-left': typeof tableHeader === 'string' ? false : tableHeader.textAlign === 'left',
                'has-text-right': typeof tableHeader === 'string' ? false : tableHeader.textAlign === 'right',
              }"
              @click.prevent="headerSortables[idx].enabled && emitSortEvent(idx)"
            >
              <span v-if="isCustom && headerLabels[idx] === 'Custom'">
                <slot name="custom" v-bind="{ headerLabels, idx }" />
              </span>
              <span v-else>
                {{ headerLabels[idx] }}
              </span>

              <span
                v-if="
                  tableHeader.dashboard && tableHeader.dashboard.status && tableHeader.dashboard.status !== 'Success'
                "
                :title="tableHeader.dashboard && tableHeader.dashboard.message"
                class="icon has-text-danger"
              >
                <i class="fa fa-exclamation-triangle" />
              </span>
            </th>
            <th v-if="actionable && actionableHeader" class="has-text-right">{{ actionableHeader }}</th>
            <th v-else-if="actionable"></th>
            <fake-table-cell v-if="fakeCellWidth > 0" :is-header-cell="true" :fake-cell-width="fakeCellWidth" />
          </table-row>
        </thead>
        <!-- table row loaders -->
        <tbody v-if="isFullTableLoaderActive || isLoaderActive">
          <table-row v-if="isFullTableLoaderActive">
            <th v-for="i in loaderCols" :key="i">
              <cell-value :is-loader-active="true" />
            </th>
          </table-row>
          <table-row v-else>
            <table-cell v-for="(tableHeader, idx) in tableHeaders" :key="headerLabels[idx]">
              <cell-value :is-loader-active="true" :cell-title="headerLabels[idx]" />
            </table-cell>
          </table-row>
        </tbody>
        <!-- table row loaders -->
        <template v-else>
          <tbody v-if="!isTableEmpty">
            <!-- table rows -->
            <slot :fake-cell-width="fakeCellWidth" />
          </tbody>
          <tbody v-else>
            <table-row class="is-hoverless">
              <table-cell
                :colspan="tableHeaders.length + (actionable ? 1 : 0) + (collapsible ? 1 : 0)"
                class="no-data-available has-text-centered"
              >
                <empty-table-info />
              </table-cell>
            </table-row>
          </tbody>
        </template>
      </table>

      <!-- table footer info start -->
      <slot name="table-footer-info" />
      <!-- table footer info end -->
    </table-container>
    <!-- pagination start -->
    <slot name="table-pagination" />
    <!-- pagination end -->
  </div>
</template>

<style lang="scss">
@import "../../../vue-components/styles/components/table";
</style>
