<script setup lang="ts">
import { onUnmounted, ref, watch } from "vue";
import type { Ref } from "vue";

interface Props {
  isActive?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  isActive: false,
});

const emit = defineEmits(["update:is-active"]);

const dropdown: Ref<HTMLElement | null> = ref(null);
const isDropdownActive = ref(props.isActive);

// attach click event listener on window, and close the dropdown
function deactivateDropdown(e: Event) {
  const { target } = e;
  if (
    isDropdownActive.value &&
    dropdown.value &&
    dropdown.value !== target &&
    !dropdown.value.contains(target as Node)
  ) {
    if (!ignoreClick.value) {
      animateDropdown("hide");
      setTimeout(() => {
        isDropdownActive.value = false;
        emit("update:is-active", false);
      }, 200);
    }
  }
}
window.addEventListener("click", deactivateDropdown);
onUnmounted(() => {
  window.removeEventListener("click", deactivateDropdown);
});

// for animation
const dropdownShowAnimation = ref(false);
const dropdownHideAnimation = ref(false);
const ignoreClick = ref(false);

function animateDropdown(type: string) {
  ignoreClick.value = true;
  if (type === "show") {
    dropdownShowAnimation.value = true;
    // remove class after 200 miliseconds
    setTimeout(() => {
      dropdownShowAnimation.value = false;
      ignoreClick.value = false;
    }, 200);
  } else {
    dropdownHideAnimation.value = true;
    setTimeout(() => {
      dropdownHideAnimation.value = false;
      ignoreClick.value = false;
    }, 200);
  }
}

watch(
  () => props.isActive,
  (n) => {
    if (ignoreClick.value) {
      // ignore new value
      // emit old value
      emit("update:is-active", isDropdownActive.value);
    } else {
      if (n) {
        animateDropdown("show");
        isDropdownActive.value = true;
      } else {
        animateDropdown("hide");
        setTimeout(() => {
          isDropdownActive.value = false;
        }, 200);
      }
    }
  }
);
</script>

<template>
  <div
    ref="dropdown"
    class="dropdown"
    :class="{
      'is-active': isDropdownActive,
      'dropdown-show-animation': dropdownShowAnimation,
      'dropdown-hide-animation': dropdownHideAnimation,
    }"
  >
    <div class="dropdown-trigger">
      <slot name="dropdown-trigger" />
    </div>
    <div id="dropdown-menu" class="dropdown-menu" role="menu">
      <div class="dropdown-content">
        <slot />
      </div>
    </div>
  </div>
</template>
