<script setup lang="ts">
import { computed, defineAsyncComponent, ref, watch } from "vue";
import type { PreviewYamlType } from "../../types/previewYaml";

interface Props {
  searchText?: string;
  toggleHideValue?: boolean;
  isPreviewLoading?: boolean;
  isEditorReadOnly?: boolean;
  previewYamls?: Array<PreviewYamlType>;
  showMinimap?: boolean;
  editorHeight?: number | string;
  wordWrap?: string;
}

const props = withDefaults(defineProps<Props>(), {
  searchText: "",
  toggleHideValue: true,
  isPreviewLoading: false,
  isEditorReadOnly: false,
  previewYamls: () => [],
  showMinimap: false,
  editorHeight: 60,
  wordWrap: "on",
});

const emit = defineEmits(["setActiveKey"]);

const Banner = defineAsyncComponent(() => import("../banner/Banner.vue"));
const Preloader = defineAsyncComponent(() => import("../preloader/Preloader.vue"));
const Editor = defineAsyncComponent({
  loader: () => import("../editor/Editor.vue"),
  loadingComponent: Preloader,
  delay: 200,
  errorComponent: Banner,
  timeout: 100000,
});
const ResourceLoader = defineAsyncComponent(() => import("../loaders/ResourceLoader.vue"));

const SidebarLoader = defineAsyncComponent(() => import("../loaders/SidebarLoader.vue"));

const activeKey = ref("");
const hideValue = ref(false);

const filteredYamls = computed(() => {
  if (props.searchText) {
    return props.previewYamls.filter((element) => JSON.stringify(element).search(props.searchText) > -1);
  } else return props.previewYamls;
});

const activeFile = computed(() => {
  const activeFile = filteredYamls.value.find((element) => element.uid === activeKey.value);
  return activeFile || { content: "", type: "yaml", isSecret: false };
});

const originalValue = computed(() => {
  const activeFile = filteredYamls.value.find((element) => element.uid === activeKey.value);
  return (activeFile && activeFile.initContent) || "";
});

const isKeyAvailable = computed(() => {
  const val = props.previewYamls.find((element) => {
    return element.uid === activeKey.value;
  });
  return val === undefined ? false : true;
});

const isYamlsEmpty = computed(() => {
  return filteredYamls.value.length === 0;
});

const isYamlsNotSelected = computed(() => {
  const val = filteredYamls.value.find((element) => {
    return element.uid === activeKey.value;
  });
  return val === undefined;
});

const initActivePreview = () => {
  if (!isKeyAvailable.value) {
    activeKey.value = props.previewYamls[0].uid;
    hideValue.value = activeFile.value.isSecret;
    emit("setActiveKey", activeKey.value);
  }
};

const setActivePreview = (uid: string) => {
  activeKey.value = uid;
  hideValue.value = activeFile.value.isSecret;
  emit("setActiveKey", activeKey.value);
};

watch(
  () => props.previewYamls,
  (n) => {
    if (n.length) {
      initActivePreview();
    }
  },
  {
    immediate: true,
    deep: true,
  }
);

watch(
  () => props.toggleHideValue,
  (n) => {
    hideValue.value = n;
  }
);
</script>

<template>
  <div class="ac-preview is-not-fixed">
    <div class="ac-preview-inner">
      <!-- preview body start  -->
      <div
        class="ac-preview-body mt-0"
        :class="{
          'is-justify-content-center': isYamlsEmpty && !isPreviewLoading,
        }"
      >
        <strong v-if="isYamlsEmpty && !isPreviewLoading">
          No Data Available
          <i class="pl-5 fa fa-exclamation-circle" aria-hidden="true"></i>
        </strong>
        <template v-else>
          <div v-if="!isPreviewLoading && previewYamls" class="left-content">
            <div class="ac-files ac-hscrollbar ac-vscrollbar pt-0">
              <ul v-if="!isPreviewLoading">
                <li
                  v-for="(previewYaml, idx) in filteredYamls"
                  :key="previewYaml.name + idx"
                  :class="{ 'is-active': activeKey === previewYaml.uid }"
                  :title="previewYaml.name"
                  data-testid="filtered-file-editor-file-name"
                >
                  <a @click.prevent="setActivePreview(previewYaml.uid)">
                    <span>
                      <img src="~@appscode/design-system-images/icons/file-icon.svg" alt="" />
                    </span>
                    <span>{{ previewYaml.name }}</span>
                  </a>
                </li>
              </ul>
              <sidebar-loader v-else />
            </div>
          </div>
          <div class="right-content" data-testid="filtered-file-editor-content">
            <resource-loader v-if="isPreviewLoading" />
            <strong v-else-if="isYamlsNotSelected">Selecet a data from sidebar</strong>
            <strong v-else-if="hideValue"> *************** </strong>
            <editor
              v-else
              v-model="activeFile.content"
              :original-value="originalValue"
              :language="activeFile.type"
              :read-only="isEditorReadOnly"
              :editor-height="editorHeight"
              :show-minimap="showMinimap"
              :word-wrap="wordWrap"
            />
          </div>
        </template>
      </div>
    </div>
  </div>
</template>
<style lang="scss">
@import "../../../vue-components/styles/components/editor/filtered-file-editor";
</style>
