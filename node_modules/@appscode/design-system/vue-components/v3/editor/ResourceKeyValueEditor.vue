<script setup lang="ts">
import { defineAsyncComponent, ref, watch, computed } from "vue";
import type { PreviewYamlType } from "../../types/previewYaml";

interface Props {
  title?: string;
  isSearchable?: boolean;
  isPreviewLoading?: boolean;
  isEditorReadOnly?: boolean;
  previewYamls?: Array<PreviewYamlType>;
  showHideBtn?: boolean;
  showMinimap?: boolean;
  isUpdateActive?: boolean;
  deleteModalStatus?: string;
  editorHeight?: number | string;
  hideHeader?: boolean;
  editorWordWrap?: string;
  modifierClass?: string;
}

const props = withDefaults(defineProps<Props>(), {
  title: "Title",
  isSearchable: false,
  isPreviewLoading: false,
  isEditorReadOnly: false,
  previewYamls: () => [],
  showHideBtn: false,
  showMinimap: false,
  isUpdateActive: false,
  deleteModalStatus: "closed",
  editorHeight: 60,
  hideHeader: false,
  editorWordWrap: "on",
  modifierClass: "",
});

const emit = defineEmits(["activeKey"]);

const AcButton = defineAsyncComponent(() => import("../button/Button.vue"));
const ContentTable = defineAsyncComponent(() => import("../content/ContentTable.vue"));
const HeaderItem = defineAsyncComponent(() => import("../header/HeaderItem.vue"));

const FilteredFileEditor = defineAsyncComponent(() => import("../editor/FilteredFileEditor.vue"));

const activeKey = ref("");
const toggleHideValue = ref(false);

const activeFile = computed(() => {
  const activeFile = props.previewYamls.find((element) => element.uid === activeKey.value);
  return activeFile || { content: "", type: "yaml", isSecret: false };
});

const setActiveKey = (key: string) => {
  activeKey.value = key;
  toggleHideValue.value = activeFile.value.isSecret;
};

watch(
  activeKey,
  (n) => {
    emit("activeKey", n);
  },
  { immediate: true }
);
</script>

<template>
  <content-table :table-title="title" :searchable="isSearchable" :hide-header="hideHeader">
    <template #content-right-controls>
      <header-item v-if="showHideBtn">
        <ac-button
          modifier-classes="is-square is-primary"
          :icon-class="toggleHideValue ? 'eye-slash' : 'eye'"
          :disabled="previewYamls.length === 0"
          @click.prevent="toggleHideValue = !toggleHideValue"
        />
      </header-item>
      <slot name="content-action" />
    </template>
    <template #content="{ searchText }">
      <filtered-file-editor
        :class="modifierClass"
        :search-text="searchText"
        :toggle-hide-value="toggleHideValue"
        :is-preview-loading="isPreviewLoading"
        :is-editor-read-only="isEditorReadOnly"
        :preview-yamls="previewYamls"
        :show-minimap="showMinimap"
        :editor-height="editorHeight"
        :word-wrap="editorWordWrap"
        @setActiveKey="setActiveKey"
      />
    </template>
  </content-table>
</template>
