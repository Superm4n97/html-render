<template>
  <div class="monaco-editor-vue3" :style="style"></div>
</template>

<script>
import { defineComponent, computed, toRefs, ref } from "vue";
import * as monaco from "monaco-editor";

export default defineComponent({
  name: "MonacoEditor",
  props: {
    diffEditor: { type: Boolean, default: false },
    width: { type: [String, Number], default: "100%" },
    height: { type: [String, Number], default: "100%" },
    original: String,
    value: String,
    language: { type: String, default: "javascript" },
    theme: { type: String, default: "vs" },
    options: {
      type: Object,
      default() {
        return {};
      },
    },
    validation: {
      type: Object,
      default: () => ({}),
    },
  },
  emits: ["editorWillMount", "editorDidMount", "change"],
  setup(props) {
    const { width, height } = toRefs(props);
    const style = computed(() => {
      const fixedWidth = width.value.toString().includes("%") ? width.value : `${width.value}px`;
      const fixedHeight = height.value.toString().includes("%") ? height.value : `${height.value}px`;
      return {
        width: fixedWidth,
        height: fixedHeight,
        "text-align": "left",
      };
    });

    const modelId = ref("");
    function updateModelId() {
      modelId.value = `file:///file-${new Date().getTime()}.yaml`;
    }
    return {
      style,
      modelId,
      updateModelId,
    };
  },
  mounted() {
    this.initMonaco();
  },
  beforeUnmount() {
    // dispose model
    monaco.editor.getModel(this.modelId)?.dispose();
    // remove the schema
    if (this.$monacoValidationOptions) {
      this.$monacoValidationOptions.schemas = this.$monacoValidationOptions.schemas.filter(
        (schema) => !schema.fileMatch.includes(this.modelId)
      );
    }
    // dispose editor
    this.editor && this.editor.dispose();
  },
  methods: {
    async initMonaco() {
      // first update the model id with unique value
      this.updateModelId();

      this.$emit("editorWillMount", this.monaco);
      const { value, language, theme, options, original, validation } = this;

      if (!this.diffEditor) {
        const modifiedModel = monaco.editor.createModel(value, language, monaco.Uri.parse(this.modelId));

        if (validation.uri) {
          if (validation.schema?.type) {
            // schema is provided
            const schemas = [
              ...(this.$monacoValidationOptions?.schemas || []),
              {
                fileMatch: [this.modelId],
                schema: validation.schema,
                uri: validation.uri,
              },
            ];
            if (this.$monacoValidationOptions) {
              this.$monacoValidationOptions.schemas = schemas;
            }
            // yaml validation
            if (this.$monacoYaml) {
              this.$monacoYaml.update({
                schemas,
              });
            }
            // json validation
            monaco.languages.json.jsonDefaults.setDiagnosticsOptions({
              validate: true,
              enableSchemaRequest: false,
              schemas,
              allowComments: true,
            });
          } else {
            // schema is not provided
            // fetch from validation uri
            const validationSchema = await fetch(validation.uri);
            if (validationSchema.ok) {
              const schema = await validationSchema.json();
              const schemas = [
                ...(this.$monacoValidationOptions?.schemas || []),
                {
                  fileMatch: [this.modelId],
                  schema,
                  uri: validation.uri,
                },
              ];
              if (this.$monacoValidationOptions) {
                this.$monacoValidationOptions.schemas = schemas;
              }
              // yaml validation
              if (this.$monacoYaml) {
                this.$monacoYaml.update({
                  schemas,
                  enableSchemaRequest: true,
                });
              }
              // json validation
              monaco.languages.json.jsonDefaults.setDiagnosticsOptions({
                validate: true,
                enableSchemaRequest: true,
                schemas,
                allowComments: true,
              });
            } else {
              // schema fetching failed
              // don't validate

              // yaml validation
              if (this.$monacoYaml) {
                this.$monacoYaml.update({
                  validate: false,
                });
              }
              // json validation
              monaco.languages.json.jsonDefaults.setDiagnosticsOptions({
                validate: false,
              });
            }
          }
        }

        this.editor = monaco.editor.create(this.$el, {
          automaticLayout: true,
          model: modifiedModel,
          theme: theme,
          fixedOverflowWidgets: true,
          ...options,
        });
      } else {
        const originalModel = monaco.editor.createModel(original, language);
        const modifiedModel = monaco.editor.createModel(value, language);
        this.editor = monaco.editor.createDiffEditor(this.$el, {
          automaticLayout: true,
          theme: theme,
          fixedOverflowWidgets: true,
          ...options,
        });
        this.editor.setModel({
          original: originalModel,
          modified: modifiedModel,
        });
      }

      // @event `change`
      const editor = this._getEditor();
      editor.onDidChangeModelContent((event) => {
        const value = editor.getValue();
        if (this.value !== value) {
          this.$emit("change", value, event);
        }
      });

      this.$emit("editorDidMount", this.editor);
    },
    _setValue(value) {
      let editor = this._getEditor();
      if (editor) return editor.setValue(value);
    },
    _getValue() {
      let editor = this._getEditor();
      if (!editor) return "";
      return editor.getValue();
    },
    _getEditor() {
      if (!this.editor) return null;
      return this.diffEditor ? this.editor.getModifiedEditor() : this.editor;
    },
    _setOriginal() {
      const { original } = this.editor.getModel();
      original.setValue(this.original);
    },
  },
  watch: {
    options: {
      deep: true,
      handler(options) {
        this.editor.updateOptions(options);
      },
    },
    value() {
      this.value !== this._getValue() && this._setValue(this.value);
    },
    original() {
      this._setOriginal();
    },
    language() {
      if (!this.editor) return;
      if (this.diffEditor) {
        const { original, modified } = this.editor.getModel();
        monaco.editor.setModelLanguage(original, this.language);
        monaco.editor.setModelLanguage(modified, this.language);
      } else monaco.editor.setModelLanguage(this.editor.getModel(), this.language);
    },
    theme() {
      monaco.editor.setTheme(this.theme);
    },
  },
});
</script>
