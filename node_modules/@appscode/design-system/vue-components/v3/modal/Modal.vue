<script setup lang="ts">
import { defineAsyncComponent, ref, watch } from "vue";
import { onClickOutside } from "@vueuse/core";

interface Props {
  open?: boolean;
  title?: string;
  modifierClasses?: string;
  isCloseOptionDisabled?: boolean;
  ignoreOutsideClick?: boolean;
  hideActionFooter?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  open: false,
  title: "Modal",
  modifierClasses: "",
  isCloseOptionDisabled: false,
  ignoreOutsideClick: false,
  hideActionFooter: false,
});

const emit = defineEmits(["closemodal"]);

const HeaderItems = defineAsyncComponent(() => import("./../header/HeaderItems.vue"));
const HeaderItem = defineAsyncComponent(() => import("./../header/HeaderItem.vue"));
const Buttons = defineAsyncComponent(() => import("./../button/Buttons.vue"));
const AcButton = defineAsyncComponent(() => import("./../button/Button.vue"));

//TODO: need to update not a currect way to import the file
const modalCloseIcon = import.meta.glob("../../../icons/close-icon.svg", {
  eager: true,
});

const modal = ref();
const showModal = ref(false);
const crossIcon = ref((modalCloseIcon["../../../icons/close-icon.svg"] as Record<string, unknown>)?.default as string);

const onKeyDown = (e: KeyboardEvent) => {
  if (props.open && e.keyCode === 27) {
    // escape key
    destroyModal();
  }
};

const initializeModal = () => {
  showModal.value = true;
  document.addEventListener("keydown", onKeyDown);
};

const onModalOutsideClick = () => {
  if (props.ignoreOutsideClick) return;
  destroyModal();
};

onClickOutside(modal, onModalOutsideClick);

const destroyModal = () => {
  if (props.isCloseOptionDisabled) return;
  showModal.value = false;
  document.removeEventListener("keydown", onKeyDown);

  emit("closemodal", true);
};

watch(
  () => props.open,
  (n) => {
    if (n) {
      initializeModal();
    } else {
      destroyModal();
    }
  },
  { immediate: true }
);
</script>

<template>
  <teleport to="#modals">
    <!-- for transition https://github.com/adamwathan/vue-tailwind-examples/blob/master/src/components/Modal.vue -->
    <!-- modal start  -->
    <div v-if="showModal" class="ac-modal is-middle-alignment" :class="modifierClasses">
      <div ref="modal" class="ac-modal-inner">
        <!-- modal header start  -->
        <div class="ac-modal-header">
          <h5>{{ title }}</h5>
          <header-items>
            <slot name="modal-header-controls" />
            <header-item>
              <ac-button
                v-if="!isCloseOptionDisabled"
                modifier-classes="is-white"
                :icon-image="crossIcon"
                data-testid="modal-generic-close-icon"
                @click.stop="destroyModal"
              />
            </header-item>
          </header-items>
        </div>
        <!-- modal header end -->

        <!-- modal body start  -->
        <div class="ac-modal-body ac-vscrollbar" data-testid="ac-modal-content-with-scroll">
          <div class="ac-modal-content">
            <!-- freedom content start  -->
            <slot />
            <!-- freedom content end -->
          </div>
        </div>
        <!-- modal body end  -->

        <!-- modal footer start -->
        <div
          v-if="!hideActionFooter"
          class="ac-modal-footer action-footer is-flex is-align-items-center is-justify-content-space-between"
        >
          <div>
            <slot name="modal-footer-left" />
          </div>
          <buttons class="has-text-right is-block">
            <slot name="modal-footer-controls" />
          </buttons>
          <!-- modal footer end -->
        </div>
      </div>
    </div>
  </teleport>
</template>

<style lang="scss" scoped>
@import "../../../vue-components/styles/components/modal";
</style>
