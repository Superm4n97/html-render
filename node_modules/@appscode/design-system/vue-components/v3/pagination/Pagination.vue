<script setup lang="ts">
import { computed, ref, watch } from "vue";

interface Props {
  hideRowsPerPageSelection?: boolean;
  totalNoOfItems?: number;
  itemsPerPage?: number;
}

const props = withDefaults(defineProps<Props>(), {
  hideRowsPerPageSelection: false,
  totalNoOfItems: 0,
  itemsPerPage: 5,
});

const emit = defineEmits(["pagination:pagechange", "pagination:countchange"]);

const activePageNo = ref(1);

const selectedItemCountPerPage = computed({
  get() {
    if (props.itemsPerPage > 5 && props.totalNoOfItems <= 5) return 5;
    else if (props.itemsPerPage > 10 && props.totalNoOfItems <= 10) return 10;
    else if (props.itemsPerPage > 15 && props.totalNoOfItems <= 15) return 15;
    else if (props.itemsPerPage > 20 && props.totalNoOfItems <= 20) return 20;
    else if (props.itemsPerPage > 25 && props.totalNoOfItems <= 25) return 25;
    else if (props.itemsPerPage > 50 && props.totalNoOfItems <= 50) return 50;

    return props.itemsPerPage;
  },
  set(n) {
    activePageNo.value = 1;
    emit("pagination:countchange", n);
  },
});

const noOfPages = computed(() => {
  return Math.ceil(props.totalNoOfItems / selectedItemCountPerPage.value);
});

const noOfPageNos = computed(() => {
  return Math.min(noOfPages.value, 5);
});

const pageRange = computed(() => {
  let o = { start: 1, end: 0 };
  if (noOfPageNos.value < 5) {
    o.start = 1;
    o.end = noOfPageNos.value;
  } else {
    if (activePageNo.value < 3) {
      o.start = 1;
      o.end = 5;
    } else if (activePageNo.value >= noOfPages.value - 2) {
      o.start = noOfPages.value - 4;
      o.end = noOfPages.value;
    } else {
      o.start = activePageNo.value - 2;
      o.end = activePageNo.value + 2;
    }
  }
  return o;
});

const pages = computed(() => {
  let ar = [];
  let start = pageRange.value.start;
  let end = pageRange.value.end;
  for (let i = start; i <= end; i++) {
    ar.push(i);
  }
  return ar;
});

const itemsRange = computed(() => {
  let start = (activePageNo.value - 1) * selectedItemCountPerPage.value;
  let end = Math.min(activePageNo.value * selectedItemCountPerPage.value, props.totalNoOfItems);

  return { start, end };
});

const showPagination = computed(() => {
  return itemsRange.value.end > itemsRange.value.start;
});

const prevPage = () => {
  activePageNo.value = Math.max(activePageNo.value - 1, 1);
};

const changePage = (page: number) => {
  activePageNo.value = page;
};

const nextPage = () => {
  activePageNo.value = Math.min(activePageNo.value + 1, noOfPages.value);
};

watch(
  itemsRange,
  (n) => {
    emit("pagination:pagechange", n);
  },
  {
    deep: true,
    immediate: true,
  }
);
</script>

<template>
  <div class="level inner-table-pagination" v-show="showPagination">
    <div class="pagination-filter level-left">
      <div class="level-item" v-show="!hideRowsPerPageSelection && totalNoOfItems > 5">
        <label>Rows per page</label>
        <select v-model="selectedItemCountPerPage" name="page" data-testid="rows-per-page-selector">
          <option :value="5">5</option>
          <option :value="10" v-show="totalNoOfItems > 5">10</option>
          <option :value="15" v-show="totalNoOfItems > 10">15</option>
          <option :value="20" v-show="totalNoOfItems > 15">20</option>
          <option :value="25" v-show="totalNoOfItems > 20">25</option>
          <option :value="50" v-show="totalNoOfItems > 25">50</option>
        </select>
      </div>
    </div>

    <nav class="pagination-item level-right">
      <p class="counting-page">
        Showing
        <span>{{ itemsRange.start + 1 }}</span
        >to <span>{{ itemsRange.end }}</span
        >of <span>{{ totalNoOfItems }}</span
        >{{ totalNoOfItems > 1 ? "Items" : "Item" }}
      </p>

      <ul v-if="totalNoOfItems > selectedItemCountPerPage">
        <li>
          <a class="previous" @click.prevent="prevPage()" data-testid="pagination-previous-page-button">
            <i class="fa fa-angle-left" aria-hidden="true"></i>
          </a>
        </li>
        <li v-for="page in pages" :key="`page-${page}`">
          <a
            @click.prevent="changePage(page)"
            data-testid="pagination-page-switch-button"
            :class="{ 'is-current': activePageNo === page }"
            >{{ page }}</a
          >
        </li>
        <li>
          <a class="next" @click.prevent="nextPage()" data-testid="pagination-next-page-button">
            <i class="fa fa-angle-right" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</template>

<style lang="scss" scoped>
.inner-table-pagination {
  padding: 4px 20px;
}

.pagination-item {
  ul {
    li {
      display: inline-block;

      a {
        display: block;
        width: 20px;
        text-align: center;
        font-size: 13px;
        font-weight: 500;
        border-radius: 4px;
        border: 1px solid $color-border;
        color: $ac-primary;
        margin-left: 4px;

        &:hover {
          background-color: $ac-primary !important;
          color: $white-100;
          border: 1px solid $color-border;
        }

        &.previous {
          background-color: $primary-97;
        }

        &.next {
          background-color: $primary-97;
        }

        &.is-current {
          background-color: $ac-primary;
          color: $white-100;
        }
      }
    }
  }
}

.counting-page,
.pagination-filter {
  color: $color-text;
  font-size: 12px;

  span {
    font-weight: 500;
    padding: 0 4px;
  }
}

.pagination-filter {
  select {
    background-color: $primary-97;
    border: 1px solid $color-border;
    border-radius: 2px;
    margin-left: 4px;
    height: 22px;
    padding: 0 4px;

    &:focus,
    &:active,
    &:focus-visible {
      border: 1px solid $ac-primary;
      outline: none;
    }
  }
}
</style>
