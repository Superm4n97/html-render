<script setup lang="ts">
import { StringCodec } from "nats.ws";
import type { NatsConnection, Subscription } from "nats.ws";
import { computed, defineAsyncComponent, getCurrentInstance, ref, watch } from "vue";
import type { Ref } from "vue";
// import type { TaskLog } from "../../types/longRunningTasks";
import type { Notification } from "../../types/notification";

const NotificationItem = defineAsyncComponent(() => import("./NotificationItem.vue"));

const notifications: Ref<Notification[]> = ref([]);
const notificationsRead = ref(0);
const unreadCount = computed(() => notifications.value.length - notificationsRead.value);

const notificationPanelOpen = ref(false);
watch(notificationPanelOpen, (n) => {
  if (n) notificationsRead.value = notifications.value.length;
});

function addNewNotification(notification: Notification) {
  notifications.value.unshift(notification);
  if (notificationPanelOpen.value) {
    notificationsRead.value = notifications.value.length;
  }
}

const app = getCurrentInstance();
const $nats: NatsConnection = app?.appContext.config.globalProperties.$nc;
let subscription: Subscription;

async function subscribeToNotifcations() {
  subscription = $nats?.subscribe("notifications");
  console.log("Started listening to Notifications");

  if (subscription) {
    // listen to channel events
    //@ts-ignore
    for await (const msg of subscription) {
      console.log("notifications ===>");
      console.log({ data: StringCodec().decode(msg.data) });
      const log = JSON.parse(StringCodec().decode(msg.data));
      console.log({ log });
      const currentTime = new Date().getTime();
      addNewNotification({
        ...log,
        id: String(currentTime),
        time: currentTime,
      });
      msg.respond();
    }
    console.log("Stopped listening to Notifications");
    console.log("Closed Channel Notifications");
  }
}
subscribeToNotifcations();
</script>

<template>
  <div @mouseenter="notificationPanelOpen = true" @mouseleave="notificationPanelOpen = false">
    <button class="button ac-nav-button">
      <span v-if="unreadCount">{{ unreadCount }}</span>
      <i class="fa fa-bell" :class="{ 'ac-shake': unreadCount }" aria-hidden="true"></i>
    </button>
    <div class="ac-menu-content is-notification">
      <div class="notification-header">
        <div class="left-content">
          <p>
            Notifications <span>({{ notifications.length }})</span>
          </p>
        </div>
        <div class="right-content"></div>
      </div>
      <div :key="notificationPanelOpen ? 1 : 0" class="notification-body">
        <transition-group v-if="notifications.length" name="slide-right">
          <notification-item
            v-for="notification in notifications"
            :key="`${notification.id}${unreadCount}`"
            :notification="notification"
          />
        </transition-group>
        <span v-else class="single-notification-item">No new notifications</span>
      </div>
    </div>
  </div>
</template>
