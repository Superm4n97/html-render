<script setup lang="ts">
import { watch, ref } from "vue";
import { useRoute } from "vue-router";

interface BreadCrumbType {
  name: string;
  path: string;
}

const list = ref<Array<BreadCrumbType>>([]);

const route = useRoute();

const pathReplaceWithParam = (path: string) => {
  //Split the path and remove the first and last empty block
  let splitPath = path.split("/").filter((element) => element !== "");

  //Replace all element with query params where the element start with ":"
  // Then again add them wthi "/" and return the path value
  return splitPath.reduce((pval, cval) => {
    if (cval[0] === ":") {
      const cutIndex = cval.indexOf("?") !== -1 ? cval.indexOf("?") : cval.length;
      return (pval += route.params[cval.slice(1, cutIndex)] + "/");
    } else return (pval += cval + "/");
  }, "/");
};

const createVal = (startIdx: number, paths: Array<string>) => {
  return paths.reduce((prev, curr, idx) => {
    if (idx >= startIdx) {
      if (idx + 1 === paths.length) return (prev += curr);
      else return (prev += curr + " / ");
    } else return prev + "";
  }, "");
};

const createList = (paths: Array<string>) => {
  //Split all the path and remove all empty block
  let spath = paths.map((element) => {
    return element.split("/").filter((word) => word !== "");
  });

  // Convert all the path arry in one arry where each element is the  different fo previous element
  return spath.reduce((prev, curr, currentIdx) => {
    if (currentIdx === 0) return prev.concat([createVal(0, curr)]);
    else return prev.concat([createVal(spath[currentIdx - 1].length, curr)]);
  }, []);
};

const createBreadcrumbs = () => {
  //Adding dynamic path to the route
  const listPaths = route.matched.map((element) => pathReplaceWithParam(element.path));

  // If there is duplicate value in arrays last element remove it
  const length = listPaths.length;
  if (length > 1 && listPaths[length - 1] === listPaths[length - 2]) listPaths.pop();

  //Createing the breadcrumb name
  const listName = createList(listPaths);

  //Set the new breadcrumb name and path value to list
  list.value = listName.map((element, index) => {
    return {
      name: element,
      path: listPaths[index],
    };
  });
};

watch(
  () => route.path,
  () => {
    createBreadcrumbs();
  },
  {
    immediate: true,
    deep: true,
  }
);
</script>

<template>
  <div class="ac-breadcrumb">
    <nav aria-label="breadcrumbs" class="breadcrumb">
      <ul>
        <li v-for="(item, idx) in list" :key="idx" :class="{ 'is-active': idx === list.length - 1 }">
          <router-link class="router-link-active" :class="{ 'is-active': idx === list.length - 1 }" :to="item.path">
            <span v-if="idx === 0" class="icon is-flex-start p-0 m-0">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M1 4.5L5.5 1L10 4.5V10C10 10.2652 9.89464 10.5196 9.70711 10.7071C9.51957 10.8946 9.26522 11 9 11H2C1.73478 11 1.48043 10.8946 1.29289 10.7071C1.10536 10.5196 1 10.2652 1 10V4.5Z"
                  stroke="#666666"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M4 11V6H7V11"
                  stroke="#666666"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
            {{ item.name }}
          </router-link>
        </li>
      </ul>
    </nav>
  </div>
</template>

<style lang="scss" scoped>
@import "../../../vue-components/styles/components/breadcrumb";
</style>
