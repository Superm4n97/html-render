<script setup lang="ts">
import { computed, defineAsyncComponent } from "vue";
import { useToast } from "vue-toastification";

interface Props {
  open?: boolean;
  editorTitle?: string;
  editorContent?: Record<string, unknown> | string | Array<any>;
}

const props = withDefaults(defineProps<Props>(), {
  open: false,
  editorTitle: "",
  editorContent: () => ({}),
});

const emit = defineEmits(["closemodal"]);

const Modal = defineAsyncComponent(() => import("./../modal/Modal.vue"));
const AcButton = defineAsyncComponent(() => import("./../button/Button.vue"));
const HeaderItem = defineAsyncComponent(() => import("./../header/HeaderItem.vue"));

const Preloader = defineAsyncComponent(() => import("./../preloader/Preloader.vue"));

const Banner = defineAsyncComponent(() => import("./../banner/Banner.vue"));

const Editor = defineAsyncComponent({
  loader: () => import("./../editor/Editor.vue").then((module) => module.default),
  loadingComponent: Preloader,
  delay: 200,
  errorComponent: Banner,
  timeout: 100000,
});

const toast = useToast();

const parsedContent = computed(() => {
  try {
    return JSON.parse(props.editorContent as string);
  } catch (e) {
    return props.editorContent;
  }
});

const onCopy = () => {
  toast.success("Value copied successfully", { timeout: 1000 });
};

const onError = () => {
  toast.error("Copying failed", { timeout: 1000 });
};

const closeModal = () => {
  emit("closemodal", true);
};
</script>

<template>
  <modal :title="editorTitle" :open="open" @closemodal="closeModal" modifier-classes="is-medium">
    <template #modal-header-controls>
      <header-item>
        <ac-button
          modifier-classes="is-square is-primary"
          icon-class="copy"
          v-clipboard:copy="`${editorTitle}: ${JSON.stringify(parsedContent, null, 4)}`"
          v-clipboard:success="onCopy"
          v-clipboard:error="onError"
        />
      </header-item>
    </template>
    <editor
      :model-value="JSON.stringify(parsedContent, null, 4)"
      :read-only="true"
      language="json"
      :show-minimap="false"
      word-wrap="on"
    />
  </modal>
</template>
