<script setup lang="ts">
import { defineAsyncComponent, ref, watch } from "vue";
import type { SelectedClusterType } from "../../types/cluster";

const Multiselect = defineAsyncComponent(() => import("vue-multiselect"));

interface Props {
  sidebarCollapsed?: boolean;
  mouseHover?: boolean;
  clusterOptions?: Array<SelectedClusterType>;
  modelValue?: string;
}

const props = withDefaults(defineProps<Props>(), {
  sidebarCollapsed: false,
  mouseHover: false,
  clusterOptions: () => [],
  modelValue: "",
});

const emit = defineEmits(["update:modelValue"]);

const selectedCluster = ref<SelectedClusterType | null>(null);
const selectedClusterName = ref<null | string>(null);

const getProviderIcon = (provider: string) => {
  return `https://cdn.appscode.com/images/cloud-provider-icons/${provider}.png`;
};

watch(
  () => props.modelValue,
  (n) => {
    selectedClusterName.value = n;
  },
  { immediate: true }
);

watch(selectedCluster, (n) => {
  if (n) {
    if (selectedClusterName.value !== n.name) {
      selectedClusterName.value = n.name;
    }
  } else selectedCluster.value = null;
});

watch(selectedClusterName, (n) => {
  if (n !== selectedCluster.value?.name) {
    props.clusterOptions.forEach((item) => {
      if (selectedClusterName.value === item.name) {
        selectedCluster.value = item;
      }
    });
  }
  emit("update:modelValue", n);
});

watch(
  () => props.clusterOptions,
  async (list) => {
    selectedCluster.value =
      list.find((item) => {
        return selectedClusterName.value === item.name;
      }) || null;
  },
  { immediate: true, deep: true }
);
</script>

<template>
  <div v-if="sidebarCollapsed" class="is-cluster-logo">
    <img
      width="40"
      :src="getProviderIcon(selectedCluster?.provider || '')"
      onerror="this.onerror=null;this.src='https://cdn.appscode.com/images/cloud-provider-icons/Generic.png';"
      alt="provider-icon"
    />
  </div>
  <multiselect
    v-else
    v-model="selectedCluster"
    placeholder="Selected Cluster"
    label="name"
    track-by="name"
    :options="clusterOptions"
    :allow-empty="false"
    deselect-label=""
    select-label=""
    selected-label=""
  >
    <template #singleLabel="props">
      <div class="is-flex is-align-items-center">
        <img
          :src="getProviderIcon(props.option.provider)"
          onerror="this.onerror=null;this.src='https://cdn.appscode.com/images/cloud-provider-icons/Generic.png';"
          alt="No cluster selected"
          class="height-22 mr-8"
        /><span
          ><span>{{ props.option.displayName }}</span></span
        >
      </div>
    </template>
    <template #option="props">
      <div class="is-flex is-align-items-center">
        <img
          class="mr-15"
          :src="getProviderIcon(props.option.provider)"
          onerror="this.onerror=null;this.src='https://cdn.appscode.com/images/cloud-provider-icons/Generic.png';"
          alt="No cluster selected"
        />
        <div>
          <p>{{ props.option.displayName }}</p>
          <p class="location">{{ props.option.location }}</p>
        </div>
      </div>
    </template>
  </multiselect>
</template>
<style lang="scss">
@import "../../../vue-components/styles/components/select-box/multi-select";
</style>
