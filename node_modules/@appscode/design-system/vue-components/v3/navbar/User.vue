<script setup lang="ts">
import { defineAsyncComponent, ref, watch, computed, nextTick } from "vue";
import HeroiconsCog6Tooth from "~icons/heroicons/cog-6-tooth";
import HeroiconsWrenchScrewdriver from "~icons/heroicons/wrench-screwdriver";
import HeroiconsUserGroup from "~icons/heroicons/user-group";
import HeroiconsPower from "~icons/heroicons/power";
import HeroiconsCheck from "~icons/heroicons/check";

import type { User } from "../../types/user";

interface FormatedOrgs extends User {
  isPersonalAccount?: boolean;
}

interface Props {
  user: FormatedOrgs;
  serverDomain?: string;
  accountsDomain?: string;
  showAccountSwitcher?: boolean;
  organizations?: Array<FormatedOrgs>;
  showThemeMode?: boolean;
  isPlatformDomain?: boolean;
  isLoggedinUserAdmin?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  serverDomain: "",
  accountsDomain: "",
  showAccountSwitcher: false,
  organizations: () => [],
  showThemeMode: false,
  isPlatformDomain: false,
  isLoggedinUserAdmin: false,
});

const emit = defineEmits(["set:theme", "on-logout", "activeorg$set"]);

const NavbarItem = defineAsyncComponent(() => import("../navbar/NavbarItem.vue"));
const NavbarItemContent = defineAsyncComponent(() => import("../navbar/NavbarItemContent.vue"));

const dropDownStatus = ref("close");
const dropDownSectionHeight = ref<string | null>(null);
const dropdownItems = ref(null as { $el: HTMLElement } | null);

const formattedOrganizations = computed(() => {
  let activeUser: User | undefined = undefined;
  const filteredList = props.organizations.filter((item) => {
    if (item.username === props.user.username) {
      activeUser = item;
    } else {
      return true;
    }
    return false;
  });

  if (activeUser) filteredList.unshift(activeUser);

  return filteredList || [];
});

const toggleList = () => {
  dropDownStatus.value = dropDownStatus.value === "open" ? "close" : "open";
  nextTick(() => {
    dropdownItems.value?.$el.scrollTo(0, 0);
  });
};

const onOrganizationClick = (orgName: string) => {
  dropdownItems.value?.$el.scrollTo(0, 0);
  emit("activeorg$set", orgName);
  handleIsActiveChange("");
};

const locationOrigin = window.location.origin;
const isDocsUi = window.location.pathname.startsWith("/docs/");

watch(dropDownStatus, (n) => {
  if (n === "open") {
    nextTick(() => {
      const dropDownUl = dropdownItems.value;
      if (dropDownUl) dropDownSectionHeight.value = `${dropDownUl.$el.scrollHeight}px`;
    });
  } else {
    dropDownSectionHeight.value = null;
  }
});

const showUserDropdown = ref(false);

function handleIsActiveChange(isActive: string) {
  dropDownStatus.value = "close";
  showUserDropdown.value = !!isActive?.length;
}
</script>

<template>
  <navbar-item
    :modifierClasses="'ac-profile-button'"
    @on-route-change="handleIsActiveChange"
    @on-is-active-change="handleIsActiveChange"
  >
    <template #navbar-item>
      <div class="ac-user-profile mr-8">
        <img :src="user.avatar_url" alt="User Photo" />
      </div>
      {{ user.full_name || user.username }}
      <i class="fa fa-angle-down" aria-hidden="true"></i>
    </template>
    <!-- <button class="button ac-nav-button ac-profile-button">

    </button> -->

    <template #navbar-content>
      <navbar-item-content v-if="showUserDropdown" class="navbar-dropdown-wrapper">
        <div v-if="user.username" class="user-profile-wrapper">
          <a
            :href="`${serverDomain}/${user.username}`"
            :title="user.username.toUpperCase()"
            data-testid="user-profile-link"
            class="line-break-anywhere is-ellipsis-1 has-text-weight-medium"
          >
            <div class="profile-area">
              <div class="profile-photo">
                <img :src="user.avatar_url" alt="User Photo" class="width-32 height-32" />
                <button class="camera-icon"></button>
              </div>
              <div class="profile-info" style="width: calc(100% - 60px)">
                <strong> {{ user.username }} </strong>
                <p>
                  {{ user.isPersonalAccount || user.is_admin ? "Personal Account" : "Organization" }}
                </p>
              </div>
            </div>
          </a>
          <transition-group name="list" tag="ul" class="list-items ac-scrollbar py-2">
            <li key="settings" v-if="serverDomain !== locationOrigin || isDocsUi">
              <a
                v-if="user.isPersonalAccount"
                data-testid="user-settings-link"
                :href="`${serverDomain}/user/settings/`"
              >
                <span class="icon">
                  <HeroiconsCog6Tooth />
                </span>
                <span>Settings</span>
              </a>
              <a v-else data-testid="user-settings-link" :href="`${serverDomain}/${user.username}/settings`">
                <span class="icon"> <HeroiconsCog6Tooth /> </span><span>Settings</span>
              </a>
            </li>
            <li key="settings-platform" v-else>
              <NuxtLink v-if="user.isPersonalAccount" data-testid="user-settings-link" :to="`/user/settings/`">
                <span class="icon">
                  <HeroiconsCog6Tooth />
                </span>
                <span>Settings</span>
              </NuxtLink>
              <NuxtLink v-else data-testid="user-settings-link" :to="`/${user.username}/settings`">
                <span class="icon"> <HeroiconsCog6Tooth /> </span><span>Settings</span>
              </NuxtLink>
            </li>

            <li v-if="showAccountSwitcher" :class="`is-${dropDownStatus}`" key="switcher">
              <a
                class="ac-dropdown-button is-fullwidth is-flex is-justify-content-space-between is-align-items-center"
                @click="toggleList()"
              >
                <div class="is-flex gap-8">
                  <span class="icon"> <HeroiconsUserGroup /> </span><span>Switch Account</span>
                </div>
                <span><i :class="`fa fa-angle-${dropDownStatus === 'open' ? 'up' : 'down'}`"></i></span>
              </a>
              <transition-group
                name="list"
                tag="ul"
                class="ac-vscrollbar"
                ref="dropdownItems"
                :style="{ maxHeight: dropDownSectionHeight }"
              >
                <li v-for="(org, idx) in formattedOrganizations" :key="org.username">
                  <a class="is-flex is-align-items-center" @click="onOrganizationClick(org.username)">
                    <div class="width-30 height-30 image">
                      <img :src="org.avatar_url" class="ac-user-profile is-rounded" alt="icon" />
                    </div>
                    <div class="is-flex is-align-items-center is-justify-content-space-between is-fullwidth ml-10">
                      <div class="org-info">
                        <strong :title="org.username" class="line-break-anywhere is-ellipsis-1">{{
                          org.username
                        }}</strong>
                        <p>
                          {{ org.isPersonalAccount ? "Personal Account" : "Organization" }}
                        </p>
                      </div>
                      <span v-if="idx === 0" class="material-icons font-size-18 ml-10 is-pulled-right">
                        <HeroiconsCheck />
                      </span>
                    </div>
                  </a>
                </li>
              </transition-group>
            </li>
            <li v-if="isLoggedinUserAdmin || user.is_admin" key="site-admin">
              <a data-testid="site-admin-link" :href="`${accountsDomain}/admin`"
                ><span class="icon"> <HeroiconsWrenchScrewdriver /> </span><span>Site Administration</span></a
              >
            </li>
            <li key="signout" @click="$emit('on-logout')">
              <a data-testid="user-logout-link" :href="`${accountsDomain}/user/logout`">
                <span class="icon">
                  <HeroiconsPower />
                </span>
                <span>Sign out</span>
              </a>
            </li>
            <!-- <li key="theme" v-if="showThemeMode">
              <theme-mode @set:theme="setTheme" />
            </li> -->
          </transition-group>
        </div>
      </navbar-item-content>
    </template>
  </navbar-item>
</template>
